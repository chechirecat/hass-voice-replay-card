name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check JavaScript syntax
      run: node -c voice-replay-card.js

    - name: Validate file structure
      run: |
        test -f voice-replay-card.js || (echo "voice-replay-card.js not found" && exit 1)
        test -f hacs.json || (echo "hacs.json not found" && exit 1)
        test -f README.md || (echo "README.md not found" && exit 1)
        test -f LICENSE || (echo "LICENSE not found" && exit 1)
        echo "âœ… All required files present"

    - name: Validate HACS configuration
      run: |
        node -e "
          const hacs = JSON.parse(require('fs').readFileSync('hacs.json', 'utf8'));
          if (!hacs.name) throw new Error('Missing name field in hacs.json');
          if (!hacs.filename) throw new Error('Missing filename field in hacs.json');
          if (hacs.filename !== 'voice-replay-card.js') throw new Error('Filename should be voice-replay-card.js');
          console.log('âœ… HACS configuration is valid');
        "

  release:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Validate version consistency
      run: |
        TAG_VERSION="${{ steps.get_version.outputs.version }}"
        
        # Extract version from card file
        CARD_VERSION=$(grep "CARD_VERSION = " voice-replay-card.js | sed -n "s/.*CARD_VERSION = '\(.*\)'.*/\1/p")
        
        echo "Tag version: $TAG_VERSION"
        echo "Card version: $CARD_VERSION"
        
        if [ "$TAG_VERSION" != "$CARD_VERSION" ]; then
          echo "Error: Tag version ($TAG_VERSION) does not match card version ($CARD_VERSION)"
          echo "Please update CARD_VERSION in voice-replay-card.js to match the tag"
          exit 1
        fi
        
        echo "âœ… Version consistency validated"

    - name: "Determine release type"
      id: release_type
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Checking version: $VERSION"
        
        # Check if it's a prerelease based on version pattern
        if [[ "$VERSION" =~ ^0\. ]]; then
          # Development versions (0.x.x) are prereleases
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "Release type: Development/Debug version (0.x.x) â†’ prerelease"
        elif [[ "$VERSION" =~ -[0-9A-Za-z.-]+ ]]; then
          # Versions with suffixes (1.0.0-beta.1, 2.0.0-rc.1) are prereleases
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
          echo "Release type: Pre-release version (contains suffix) â†’ prerelease"
        else
          # Stable versions (1.0.0, 2.1.0) are full releases
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "Release type: Stable version (1.x.x+) â†’ full release"
        fi

    - name: "Get Latest Release for Comparison"
      id: latest_release
      run: |
        # Get the latest release (marked as "Latest" in GitHub) for comparison
        echo "Fetching latest release from GitHub API..."
        
        # Use GitHub API to get the latest release
        LATEST_RELEASE_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/releases/latest")
        
        # Extract tag name from the response
        LATEST_TAG=$(echo "$LATEST_RELEASE_JSON" | jq -r '.tag_name // empty')
        
        if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
          echo "No latest release found, this might be the first release"
          echo "latest_tag=" >> $GITHUB_OUTPUT
          echo "has_latest=false" >> $GITHUB_OUTPUT
        else
          echo "Latest release tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "has_latest=true" >> $GITHUB_OUTPUT
        fi

    - name: Create Release Notes
      id: release_notes
      run: |
        # Create release notes
        cat > release_notes.md << EOF
        ## Voice Replay Card v${{ steps.get_version.outputs.version }}
        
        ### Installation
        
        #### Via HACS (Recommended)
        1. Add this repository to HACS as a custom repository
        2. Search for "Voice Replay Card" in HACS Frontend
        3. Install and restart Home Assistant
        
        #### Manual Installation
        1. Download \`voice-replay-card.js\` from this release
        2. Place it in your \`<config>/www/\` folder in Home Assistant
        3. Add the card resource in your Lovelace configuration:
           \`\`\`yaml
           resources:
             - url: /local/voice-replay-card.js
               type: module
           \`\`\`
        
        ### Requirements
        * Home Assistant 2025.10.4 or newer
        * Voice Replay Integration (install separately)
        
        ### Features
        * ðŸŽ¤ Record voice messages directly in your dashboard
        * ðŸ—£ï¸ Convert text to speech and play on media players
        * ðŸ“± Responsive design that works on mobile and desktop
        * ðŸŽ¨ Follows Home Assistant design system
        
        ### What's Changed
        * Updated to version ${{ steps.get_version.outputs.version }}
        * See commit history for detailed changes
        
        EOF
        
        # Add comparison URL based on latest release
        if [ "${{ steps.latest_release.outputs.has_latest }}" == "true" ]; then
          echo "**Full Changelog**: https://github.com/chechirecat/hass-voice-replay-card/compare/${{ steps.latest_release.outputs.latest_tag }}...${{ steps.get_version.outputs.tag }}" >> release_notes.md
        else
          echo "**Full Changelog**: https://github.com/chechirecat/hass-voice-replay-card/commits/${{ steps.get_version.outputs.tag }}" >> release_notes.md
        fi

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        release_name: Voice Replay Card ${{ steps.get_version.outputs.tag }}
        body_path: release_notes.md
        draft: false
        prerelease: ${{ steps.release_type.outputs.is_prerelease }}

    - name: Upload voice-replay-card.js
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./voice-replay-card.js
        asset_name: voice-replay-card.js
        asset_content_type: application/javascript